title: Occupants
icon: mdi:account-group
views:
- title: Occupants
  type: panel
  cards:
  - type: custom:stack-in-card
    mode: vertical
    card_mod:
      style: |
        ha-card {
          background: transparent !important;
          box-shadow: none !important;
        }
    cards:

    # ── Household ──────────────────────────────────────
    - type: custom:bubble-card
      card_type: separator
      name: Household
      icon: mdi:home-account
      styles: |
        .bubble-line {
          background: rgba(255, 255, 255, 0.3) !important;
        }

    - type: horizontal-stack
      cards:

      # ── Sadat ──
      - type: custom:mushroom-template-card
        primary: Sadat
        secondary: >-
          {% if states('person.sadat_anwar') == 'home' %}Home
          {%- else %}Away{% endif %}
        icon: mdi:face-man
        icon_color: >-
          {{ 'blue' if states('person.sadat_anwar') == 'home' else 'disabled' }}
        entity: person.sadat_anwar
        tap_action:
          action: more-info
        card_mod:
          style: |
            ha-card {
              background: rgba(255, 255, 255, 0.1) !important;
              backdrop-filter: blur(10px);
              -webkit-backdrop-filter: blur(10px);
              border: 1px solid rgba(255, 255, 255, 0.2);
              border-radius: 16px;
              box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            }

      # ── Aliza ──
      - type: custom:mushroom-template-card
        primary: Aliza
        secondary: >-
          {% if states('person.aliza') == 'home' %}Home
          {%- else %}Away{% endif %}
        icon: mdi:face-woman
        icon_color: >-
          {{ 'pink' if states('person.aliza') == 'home' else 'disabled' }}
        entity: person.aliza
        tap_action:
          action: more-info
        card_mod:
          style: |
            ha-card {
              background: rgba(255, 255, 255, 0.1) !important;
              backdrop-filter: blur(10px);
              -webkit-backdrop-filter: blur(10px);
              border: 1px solid rgba(255, 255, 255, 0.2);
              border-radius: 16px;
              box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            }

    # ── Guests ──────────────────────────────────────
    - type: custom:bubble-card
      card_type: separator
      name: Guests
      icon: mdi:account-group
      styles: |
        .bubble-line {
          background: rgba(255, 255, 255, 0.3) !important;
        }

    - type: markdown
      content: |
        {% set exclude_ids = [
          'device_tracker.sadats_iphone_15_olx',
          'device_tracker.alizas_iphone',
          'device_tracker.iphone_2',
          'device_tracker.iphone_6',
          'device_tracker.iphone_8',
          'device_tracker.pc_192_168_178_116',
          'device_tracker.syed_sadats_ipad',
          'device_tracker.syed_sadats_ipad_2',
          'device_tracker.sadats_mbp',
          'device_tracker.sadats_mbp_2',
          'device_tracker.sadatsione15olx',
          'device_tracker.de_olx_j60xrd633h',
          'device_tracker.de_olx_j60xrd633h_2',
          'device_tracker.fritz_repeater_entrance',
          'device_tracker.fritz_repeater_gf',
          'device_tracker.fritz_repeater_office',
          'device_tracker.homeassistant',
          'device_tracker.macmini_7',
          'device_tracker.macbookpro_2'
        ] %}
        {% set iot_kw = 'shelly|meross|dreame|eufy|viessmann|vitodens|tasmota|esp32|switchbot|relay|vacuum|camera|doorbell|siemens|dishwasher|oven|washing|freezer|smartnetz|dehumidifier|amazon|echo|sonos|chromecast|apple_tv|homepod|sbs50|printer|bridge|gateway|base_station|smart_plug|smart_roller|roller_shutter|midea' %}
        {% set ns = namespace(named=[], unnamed=0, total=0) %}
        {% for e in states.device_tracker | sort(attribute='attributes.friendly_name') %}
          {% set name = e.attributes.friendly_name | default(e.entity_id) %}
          {% set eid = e.entity_id %}
          {% if e.state == 'home'
             and eid not in exclude_ids
             and state_attr(eid, 'source_type') == 'router'
             and not (eid | lower is search(iot_kw))
             and not (name | lower is search(iot_kw)) %}
            {% set ns.total = ns.total + 1 %}
            {% if (name | lower) is match('pc[-_]') %}
              {% set ns.unnamed = ns.unnamed + 1 %}
            {% else %}
              {% set ap = state_attr(eid, 'connected_to') | default('') %}
              {% if ap == 'fritz.box' %}{% set floor = ' · 1st Floor' %}
              {% elif ap == 'fritz-repeater-entrance' %}{% set floor = ' · Ground Floor' %}
              {% elif ap == 'fritz-repeater-office' %}{% set floor = ' · Top Floor' %}
              {% else %}{% set floor = '' %}{% endif %}
              {% set ns.named = ns.named + [name ~ floor] %}
            {% endif %}
          {% endif %}
        {% endfor %}
        {% if ns.total > 0 %}
        **{{ ns.total }}** guest device{{ 's' if ns.total != 1 else '' }}
        {% for entry in ns.named %}
        - {{ entry }}
        {% endfor %}
        {% if ns.unnamed > 0 %}
        *+ {{ ns.unnamed }} unidentified device{{ 's' if ns.unnamed != 1 else '' }}*
        {% endif %}
        {% else %}
        *No guest devices connected*
        {% endif %}
      card_mod:
        style: |
          ha-card {
            background: rgba(255, 255, 255, 0.1) !important;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
          }
